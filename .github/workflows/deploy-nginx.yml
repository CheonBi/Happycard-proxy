name: Nginx Config Deployment

on:
  push:
    branches:
      - main

env:
  HOST_NAME: ${{ secrets.HAPPY_HOST_NAME }}
  NGINX_BASE_PATH: '~/projects'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # SSH 접속 및 파일 동기화
      - name: Sync Nginx Config to Ubuntu Sever
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.HAPPY_PUBLIC_IP }}
          username: ${{ secrets.HAPPY_HOST_NAME }}
          key: ${{ secrets.HAPPY_PRIVATE_KEY }}
          source: './'
          target: /home/${{ secrets.HAPPY_HOST_NAME }}/projects/
          
      # SSH 접속 및 Nginx 컨테이너 재시작
      - name: Restart Nginx Container
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.HAPPY_PUBLIC_IP }}
          username: ${{ secrets.HAPPY_HOST_NAME }}
          key: ${{ secrets.HAPPY_PRIVATE_KEY }}
          script: |
            BACKUP_DIR="${{ env.NGINX_BASE_PATH }}/backup"
            
            echo "Creating backup..."
            
            sudo mkdir -p "$BACKUP_DIR/conf.d"

            cd /home/${{ secrets.HAPPY_HOST_NAME }}/projects/
            
            docker-compose up -d --force-recreate nginx
            
            echo "NGINX config updated and container restarted."
    
  
